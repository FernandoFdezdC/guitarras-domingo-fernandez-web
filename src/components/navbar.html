<link rel="stylesheet" href="/css/navbar.css">

<nav class="w-full flex items-center justify-between py-4 px-4 sm:px-8 bg-[#4d0000] transition-transform duration-300">
    <!-- Title on the left -->
    <span id="nav-title" class="text-3xl font-bold text-white">Guitarras Domingo Fernández</span>
    
    <!-- Container for right-side elements -->
    <div class="flex items-center gap-6">
        <!-- Navigation links (visible on desktop) -->
        <div class="hidden sm:flex gap-6">
            <a id="nav-home" href="#" class="nav-button inactive">Inicio</a>
            <a id="nav-guitars" href="#" class="nav-button inactive">Guitarras</a>
            <a id="nav-contact" href="#" class="nav-button inactive">Contacto</a>
        </div>
        
        <!-- Desktop language selector -->
        <div class="hidden sm:block relative">
            <button id="lang-trigger" type="button" class="transition-colors flex items-center justify-center text-white h-10 w-10 rounded-full bg-[#660000] hover:bg-[#CC3939] cursor-pointer">
                <i class="fas fa-globe text-xl"></i>
            </button>
            
            <div id="lang-dropdown" class="lang-popup hidden">
                <div id="lang-option-es" class="lang-option rounded-t-lg">🇪🇸 Español</div>
                <div id="lang-option-en" class="lang-option rounded-b-lg">🇬🇧 English</div>
            </div>
        </div>
        
        <!-- Hamburger menu button (mobile only) -->
        <button id="mobile-menu-button" class="sm:hidden text-white focus:outline-none">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>
</nav>

<!-- Mobile menu -->
<div id="mobile-menu" class="sm:hidden w-full flex flex-col hidden">
    <a id="mobile-nav-home" href="#" class="mobile-nav-item inactive">Inicio</a>
    <a id="mobile-nav-guitars" href="#" class="mobile-nav-item inactive">Guitarras</a>
    <a id="mobile-nav-contact" href="#" class="mobile-nav-item inactive">Contacto</a>
    
    <!-- Mobile language button -->
    <a id="mobile-lang-button" href="javascript:void(0)" class="mobile-nav-item inactive">
        Idioma
    </a>
</div>

<!-- Mobile language popup -->
<div id="mobile-lang-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-[#660000] p-6 rounded-lg w-64" id="mobile-lang-popup-content">
    <button id="mobile-lang-option-es" class="w-full text-left py-3 px-4 rounded-md transition-colors text-white mb-2">
      🇪🇸 Español
    </button>
    <button id="mobile-lang-option-en" class="w-full text-left py-3 px-4 rounded-md transition-colors text-white">
      🇬🇧 English
    </button>
  </div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="loading-overlay hidden">
    <span class="text-white text-2xl">Cargando...</span>
</div>

<script>
/* ---------- Navbar helpers and logic ---------- */
function defineNavbarLogic() {
  // If the logic has already been defined before, do not redefine it
  if (window._navbarLogicDefined) return;
  window._navbarLogicDefined = true;

  /* ---------- cookie helpers ---------- */
  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return undefined;
  }
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + (days || 365) * 24 * 60 * 60 * 1000);
    const expires = "expires=" + d.toUTCString();
    document.cookie = `${name}=${value}; ${expires}; path=/; SameSite=Lax`;
  }

  /* ---------- simple translations ---------- */
  const translations = {
    es: {
      title: "Guitarras Domingo Fernández",
      home: "Inicio",
      guitars: "Guitarras",
      contact: "Contacto",
      language: "Idioma",
      loading: "Cargando..."
    },
    en: {
      title: "Domingo Fernández Guitars",
      home: "Home",
      guitars: "Guitars",
      contact: "Contact",
      language: "Language",
      loading: "Loading..."
    }
  };

  /* ---------- State ---------- */
  let currentLang = 'es';
  let menuOpen = false;
  let langDropdownOpen = false;

  /* ---------- route utility (preserves path after language change) ---------- */
  function buildPathWithLang(lang, target = null) {
    // Get the current path
    const pathname = window.location.pathname.replace(/\/index\.html$/, '');
    const parts = pathname.split('/'); // ['', 'es', 'guitarras', ...]

    let newParts = [...parts];

    // If there is no language in the path, insert it
    if (!parts[1] || (parts[1] !== 'es' && parts[1] !== 'en')) {
        newParts = ['', lang];
    } else {
        newParts[1] = lang; // Replace language
    }

    // If a target is provided, replace the second part or add it
    if (target !== null) {
        newParts = ['', lang, target];
    }

    let newPath = newParts.join('/').replace(/\/+/g, '/');

    // Ensure trailing slash
    if (!newPath.endsWith('/')) newPath += '/';

    return newPath;
  }

  /* ---------- update texts and links ---------- */
  function updateTexts() {
    const t = translations[currentLang] || translations.es;
    const elTitle = document.getElementById('nav-title');
    if (elTitle) elTitle.textContent = t.title;
    const mapText = [
      ['nav-home', t.home],
      ['nav-guitars', t.guitars],
      ['nav-contact', t.contact],
      ['mobile-nav-home', t.home],
      ['mobile-nav-guitars', t.guitars],
      ['mobile-nav-contact', t.contact],
      ['mobile-lang-button', t.language],
    ];
    mapText.forEach(([id, txt]) => {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    });
    const mobileLangBtn = document.getElementById('mobile-lang-button');
    if (mobileLangBtn) {
      mobileLangBtn.addEventListener('click', () => {
        openMobileLangPopup(); // open language popup
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu) mobileMenu.classList.add('hidden'); // close the menu
      });
    }
    const overlaySpan = document.querySelector('#loading-overlay span');
    if (overlaySpan) overlaySpan.textContent = t.loading;
  }

  function setupLinks() {
    const homeHref = buildPathWithLang(currentLang, '');               // /es/ or /en/
    const guitarsHref = buildPathWithLang(currentLang, 'guitarras'); // /es/guitarras/
    const contactHref = buildPathWithLang(currentLang, 'contacto');  // /es/contacto/

    const map = [
        ['nav-home', homeHref],
        ['nav-guitars', guitarsHref],
        ['nav-contact', contactHref],
        ['mobile-nav-home', homeHref],
        ['mobile-nav-guitars', guitarsHref],
        ['mobile-nav-contact', contactHref],
    ];

    map.forEach(([id, href]) => {
        const el = document.getElementById(id);
        if (el) el.setAttribute('href', href);
    });
  }

  /* ---------- loading overlay ---------- */
  function setupNavLinkLoading() {
    const navIds = ['nav-home', 'nav-guitars', 'nav-contact', 'mobile-nav-home', 'mobile-nav-guitars', 'mobile-nav-contact'];
    navIds.forEach(id => {
      const link = document.getElementById(id);
      if (!link) return;
      link.addEventListener('click', (e) => {
        // get the pathname of the link
        const targetPath = new URL(link.href, window.location.origin).pathname.replace(/\/index\.html$/, '/');
        const currentPath = window.location.pathname.replace(/\/index\.html$/, '/');
        if (targetPath !== currentPath) {
          const overlay = document.getElementById('loading-overlay');
          if (overlay) {
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex'; // or 'block' depending on the CSS
          }
        }
        // No preventDefault: allow navigation to the actual URL
      });
    });
  }

  /* ---------- active link ---------- */
  function updateActiveLink() {
    const pathname = window.location.pathname.replace(/\/index\.html$/, '/');
    const base = `/${currentLang}`;
    const links = {
      home: ['nav-home', 'mobile-nav-home'],
      guitars: ['nav-guitars', 'mobile-nav-guitars'],
      contact: ['nav-contact', 'mobile-nav-contact']
    };

    // reset
    Object.values(links).flat().forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.classList.remove('active');
        el.classList.add('inactive');
      }
    });

    if (pathname === `${base}/` || pathname === `${base}`) {
      links.home.forEach(id => { const el=document.getElementById(id); if(el){el.classList.remove('inactive'); el.classList.add('active')}} );
    } else if (pathname.includes(`${base}/guitarras`)) {
      links.guitars.forEach(id => { const el=document.getElementById(id); if(el){el.classList.remove('inactive'); el.classList.add('active')}} );
    } else if (pathname.includes(`${base}/contacto`)) {
      links.contact.forEach(id => { const el=document.getElementById(id); if(el){el.classList.remove('inactive'); el.classList.add('active')}} );
    }
  }

  /* ---------- UI toggles ---------- */
  function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobile-menu');
    if (!mobileMenu) return;
    menuOpen = !menuOpen;
    mobileMenu.classList.toggle('hidden');
  }
  function toggleLangDropdown(e) {
    if (e && e.stopPropagation) e.stopPropagation();
    langDropdownOpen = !langDropdownOpen;
    const dd = document.getElementById('lang-dropdown');
    if (!dd) return;
    if (langDropdownOpen) {
      dd.classList.remove('hidden');
      const firstOpt = dd.querySelector('.lang-option');
      if (firstOpt && firstOpt.focus) firstOpt.focus();
      setTimeout(() => { document.addEventListener('click', docCloseHandler); }, 0);
    } else {
      dd.classList.add('hidden');
      document.removeEventListener('click', docCloseHandler);
    }
  }
  function openMobileLangPopup() {
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenu) mobileMenu.classList.add('hidden');
    const popup = document.getElementById('mobile-lang-popup');
    if (popup) popup.classList.remove('hidden');
  }
  function closeMobileLangPopup() {
    const popup = document.getElementById('mobile-lang-popup');
    if (popup) popup.classList.add('hidden');
  }

  /* ---------- change language ---------- */
  function changeLanguage(lang) {
    if (lang !== 'es' && lang !== 'en') return;

    // If the language is the same, do nothing
    if (lang === currentLang) return;

    // Show overlay with the current language text (before changing currentLang)
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        const overlaySpan = overlay.querySelector('span');
        if (overlaySpan) {
            const t = translations[currentLang] || translations.es;
            overlaySpan.textContent = t.loading;
        }
        overlay.classList.remove('hidden');
        overlay.style.display = 'flex';
    }

    // We update the cookie and currentLang afterwards
    setCookie('preferred_language', lang, 365);
    currentLang = lang;
    document.documentElement.lang = lang;

    setupLinks();
    updateActiveLink();

    // Redirect to the route with the new language
    const newPath = buildPathWithLang(lang);
    if (newPath !== window.location.pathname) {
        window.location.replace(newPath);
    }
  }

  /* ---------- initialize navbar ---------- */
  function initNavbarInner() {
    // language cookie
    const cookieLang = getCookie('preferred_language');
    if (cookieLang === 'es' || cookieLang === 'en') currentLang = cookieLang;
    document.documentElement.lang = currentLang;

    updateTexts();
    setupLinks();
    setupNavLinkLoading();
    updateActiveLink();

    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.add('hidden');
      overlay.style.display = 'none';
    }

    // UI events
    const mobileBtn = document.getElementById('mobile-menu-button');
    if (mobileBtn) mobileBtn.addEventListener('click', toggleMobileMenu);

    const langTrigger = document.getElementById('lang-trigger');
    if (langTrigger) {
      langTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleLangDropdown(e);
      });
    }

    const ddEs = document.getElementById('lang-option-es');
    const ddEn = document.getElementById('lang-option-en');
    function updateLangDropdown() {
      const ddEs = document.getElementById('lang-option-es');
      const ddEn = document.getElementById('lang-option-en');
      if (!ddEs || !ddEn) return;

      // Remove class to both of them
      ddEs.classList.remove('bg-[#aa2929]');
      ddEn.classList.remove('bg-[#aa2929]');

      // Apply the current language
      if (currentLang === 'es') {
        ddEs.classList.add('bg-[#aa2929]');
      } else if (currentLang === 'en') {
        ddEn.classList.add('bg-[#aa2929]');
      }
    }
    updateLangDropdown();
    if (ddEs) ddEs.addEventListener('click', () => changeLanguage('es'));
    if (ddEn) ddEn.addEventListener('click', () => changeLanguage('en'));

    const mobileLangBtn = document.getElementById('mobile-lang-button');
    if (mobileLangBtn) mobileLangBtn.addEventListener('click', openMobileLangPopup);
    const mobileLangEs = document.getElementById('mobile-lang-option-es');
    const mobileLangEn = document.getElementById('mobile-lang-option-en');
    const closeLangBtn = document.getElementById('close-lang-popup');

    updateLangDropdown();
    // We do not redirect here by design: the root page (/index.html) is responsible for redirecting to /es/ or /en/ if applicable
    
    const mobileLangPopup = document.getElementById('mobile-lang-popup');

    function updateMobileLangPopupStyles() {
        if (!mobileLangEs || !mobileLangEn) return;
        if (currentLang === 'es') {
            mobileLangEs.classList.add('bg-[#AA2929]');
            mobileLangEs.classList.remove('bg-[#660000]');
            mobileLangEn.classList.remove('bg-[#AA2929]');
            mobileLangEn.classList.add('bg-[#660000]');
        } else {
            mobileLangEn.classList.add('bg-[#AA2929]');
            mobileLangEn.classList.remove('bg-[#660000]');
            mobileLangEs.classList.remove('bg-[#AA2929]');
            mobileLangEs.classList.add('bg-[#660000]');
        }
    }

    if (mobileLangEs) mobileLangEs.addEventListener('click', () => {
        changeLanguage('es');
        if (mobileLangPopup) mobileLangPopup.classList.add('hidden');
        updateMobileLangPopupStyles();
    });
    if (mobileLangEn) mobileLangEn.addEventListener('click', () => {
        changeLanguage('en');
        if (mobileLangPopup) mobileLangPopup.classList.add('hidden');
        updateMobileLangPopupStyles();
    });

    if (closeLangBtn) closeLangBtn.addEventListener('click', () => {
        if (mobileLangPopup) mobileLangPopup.classList.add('hidden');
    });

    // Close when clicking outside the content
    if (mobileLangPopup) {
        mobileLangPopup.addEventListener('click', () => {
            mobileLangPopup.classList.add('hidden');
        });
        const popupContent = mobileLangPopup.querySelector('div.absolute');
        if (popupContent) {
            popupContent.addEventListener('click', e => e.stopPropagation());
        }
    }

    // Initialize styles when loading
    updateMobileLangPopupStyles();
  }

  // Expose initNavbar globally for compatibility
  window.initNavbar = initNavbarInner;

  // Dropdown close function when clicking outside
  function docCloseHandler(e) {
    const langTrigger = document.getElementById('lang-trigger');
    const langDropdown = document.getElementById('lang-dropdown');
    if (!langDropdown) return;
    if (langDropdown.classList.contains('hidden')) return;
    const target = e.target;
    if ((langTrigger && langTrigger.contains(target)) || langDropdown.contains(target)) {
      return;
    }
    langDropdown.classList.add('hidden');
    langDropdownOpen = false;
    document.removeEventListener('click', docCloseHandler);
  }

  // Manual initialization function in case initNavbar does not exist (fallback)
  window.initializeNavbarManually = function initializeNavbarManually() {
    console.log('[navbar] manually initializing (fallback)...');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
    }
    // Basic language selector
    const langTrigger = document.getElementById('lang-trigger');
    const langDropdown = document.getElementById('lang-dropdown');
    if (langTrigger && langDropdown) {
      langTrigger.addEventListener('click', (e) => { e.stopPropagation(); langDropdown.classList.toggle('hidden'); });
      document.addEventListener('click', () => langDropdown.classList.add('hidden'));
    }
  };
}
defineNavbarLogic();
document.addEventListener('DOMContentLoaded', () => {
    if (typeof initNavbar === 'function') {
        initNavbar();
    } else {
        console.warn('initNavbar is not defined. Initializing manually.');
        if (typeof initializeNavbarManually === 'function') {
            initializeNavbarManually();
        }
    }
});
</script>