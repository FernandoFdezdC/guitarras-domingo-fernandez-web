<link rel="stylesheet" href="/css/navbar.css">

<nav class="w-full flex items-center justify-between py-4 px-4 sm:px-8 navbar-bg">
    <!-- TÃ­tulo a la izquierda -->
    <span id="nav-title" class="text-3xl font-bold text-white">Guitarras Domingo FernÃ¡ndez</span>
    
    <!-- Contenedor para elementos de la derecha -->
    <div class="flex items-center gap-6">
        <!-- Enlaces de navegaciÃ³n (visible en desktop) -->
        <div class="hidden sm:flex gap-6">
            <a id="nav-home" href="#" class="nav-button inactive">Inicio</a>
            <a id="nav-guitars" href="#" class="nav-button inactive">Guitarras</a>
            <a id="nav-contact" href="#" class="nav-button inactive">Contacto</a>
        </div>
        
        <!-- Selector de idioma desktop -->
        <div class="hidden sm:block relative">
            <button id="lang-trigger" type="button" class="transition-colors flex items-center justify-center text-white h-10 w-10 rounded-full bg-[#660000] hover:bg-[#CC3939] cursor-pointer">
                <i class="fas fa-globe text-xl"></i>
            </button>
            
            <div id="lang-dropdown" class="lang-popup hidden">
                <div id="lang-option-es" class="lang-option rounded-t-lg">ðŸ‡ªðŸ‡¸ EspaÃ±ol</div>
                <div id="lang-option-en" class="lang-option rounded-b-lg">ðŸ‡¬ðŸ‡§ English</div>
            </div>
        </div>
        
        <!-- BotÃ³n de menÃº hamburguesa (solo mÃ³vil) -->
        <button id="mobile-menu-button" class="sm:hidden text-white focus:outline-none">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>
</nav>

<!-- MenÃº mÃ³vil -->
<div id="mobile-menu" class="sm:hidden w-full flex flex-col hidden">
    <a id="mobile-nav-home" href="#" class="mobile-nav-item inactive">Inicio</a>
    <a id="mobile-nav-guitars" href="#" class="mobile-nav-item inactive">Guitarras</a>
    <a id="mobile-nav-contact" href="#" class="mobile-nav-item inactive">Contacto</a>
    
    <!-- BotÃ³n de idioma mÃ³vil -->
    <div class="relative border-b-2 border-[#8B0000]">
        <button id="mobile-lang-button" class="w-full text-white font-medium text-sm h-12 bg-[#660000] hover:bg-[#aa2929] px-4 text-center">
            Idioma
        </button>
    </div>
</div>

<!-- Popup de idioma mÃ³vil -->
<div id="mobile-lang-popup" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="absolute bottom-0 left-0 right-0 bg-[#660000] rounded-t-2xl p-4">
        <h3 class="text-white text-lg font-bold mb-4">Seleccionar idioma</h3>
        <div class="flex flex-col gap-2">
            <button id="mobile-lang-option-es" class="px-4 py-2 bg-[#aa2929] text-white rounded-lg">EspaÃ±ol</button>
            <button id="mobile-lang-option-en" class="px-4 py-2 bg-[#660000] hover:bg-[#aa2929] text-white rounded-lg">English</button>
        </div>
        <button id="close-lang-popup" class="mt-4 w-full px-4 py-2 bg-[#8B0000] text-white rounded-lg">Cerrar</button>
    </div>
</div>

<!-- Overlay de carga -->
<div id="loading-overlay" class="loading-overlay hidden">
    <span class="text-white text-2xl">Cargando...</span>
</div>

<script>
    /* ---------- helpers cookies ---------- */
    function getCookie(name) {
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return undefined;
    }
    function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + (days||365) * 24*60*60*1000);
    const expires = "expires=" + d.toUTCString();
    // NOT setting Secure here to allow non-HTTPS testing; add ; Secure when using HTTPS+production
    document.cookie = `${name}=${value}; ${expires}; path=/; SameSite=Lax`;
    }

    /* ---------- translations / estado ---------- */
    const translations = {
    es: {
        title: "Guitarras Domingo FernÃ¡ndez",
        home: "Inicio",
        guitars: "Guitarras",
        contact: "Contacto",
        language: "Idioma",
        loading: "Cargando..."
    },
    en: {
        title: "Guitars Domingo FernÃ¡ndez",
        home: "Home",
        guitars: "Guitars",
        contact: "Contact",
        language: "Language",
        loading: "Loading..."
    }
    };

    let currentLang = 'es';
    let menuOpen = false;
    let langDropdownOpen = false;
    let suppressDocClose = false; // controla cierres inmediatos tras abrir el dropdown

    /* ---------- util rutas (preserva la ruta tras cambiar idioma) ---------- */
    function buildPathWithLang(lang) {
    // Reemplaza/Inserta el primer segmento de la ruta con lang.
    const pathname = window.location.pathname;
    const parts = pathname.split('/'); // ['', 'es', 'guitarras', ...] o ['', '']
    if (!parts[1] || (parts[1] !== 'es' && parts[1] !== 'en')) {
        // no hay segmento de idioma -> insertar
        const newPath = (`/${lang}${pathname}`).replace(/\/+/g,'/');
        return newPath.endsWith('/') ? newPath : newPath + '/';
    } else if (parts[1] !== lang) {
        parts[1] = lang;
        let p = parts.join('/');
        p = p.replace(/\/+/g,'/');
        return p.endsWith('/') ? p : p + (p.endsWith('/index.html') ? '' : '/');
    } else {
        // ya estÃ¡ en el mismo idioma; normalizar trailing slash
        return pathname.endsWith('/') ? pathname : pathname.replace(/\/index\.html$/, '/') ;
    }
    }

    /* ---------- actualizar textos y links ---------- */
    function updateTexts() {
    const t = translations[currentLang];
    if (document.getElementById('nav-title')) document.getElementById('nav-title').textContent = t.title;
    if (document.getElementById('nav-home')) document.getElementById('nav-home').textContent = t.home;
    if (document.getElementById('nav-guitars')) document.getElementById('nav-guitars').textContent = t.guitars;
    if (document.getElementById('nav-contact')) document.getElementById('nav-contact').textContent = t.contact;
    if (document.getElementById('mobile-nav-home')) document.getElementById('mobile-nav-home').textContent = t.home;
    if (document.getElementById('mobile-nav-guitars')) document.getElementById('mobile-nav-guitars').textContent = t.guitars;
    if (document.getElementById('mobile-nav-contact')) document.getElementById('mobile-nav-contact').textContent = t.contact;
    if (document.getElementById('mobile-lang-button')) document.getElementById('mobile-lang-button').textContent = t.language;
    const loadSpan = document.querySelector('#loading-overlay span');
    if (loadSpan) loadSpan.textContent = t.loading;
    }

    function setupLinks() {
    const basePath = `/${currentLang}`;
    // AquÃ­ usamos rutas con trailing slash â€” asegÃºrate de que en S3 exista /es/guitarras/index.html
    const homeHref = `${basePath}/`;
    const guitarsHref = `${basePath}/guitarras/`;
    const contactHref = `${basePath}/contacto/`;

    const map = [
        ['nav-home', homeHref],
        ['nav-guitars', guitarsHref],
        ['nav-contact', contactHref],
        ['mobile-nav-home', homeHref],
        ['mobile-nav-guitars', guitarsHref],
        ['mobile-nav-contact', contactHref],
    ];
    map.forEach(([id, href]) => {
        const el = document.getElementById(id);
        if (el) el.setAttribute('href', href);
    });
    }

    /* ---------- overlay loading: compara pathname (no href absoluto) ---------- */
    function setupNavLinkLoading() {
    const navIds = ['nav-home','nav-guitars','nav-contact','mobile-nav-home','mobile-nav-guitars','mobile-nav-contact'];
    navIds.forEach(id => {
        const link = document.getElementById(id);
        if (!link) return;
        link.addEventListener('click', (e) => {
        // obtener pathname del enlace
        const targetPath = new URL(link.href, window.location.origin).pathname.replace(/\/index\.html$/, '/');
        const currentPath = window.location.pathname.replace(/\/index\.html$/, '/');
        if (targetPath !== currentPath) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.remove('hidden');
        } else {
            // misma pÃ¡gina -> prevenir overlay
        }
        // no preventDefault: dejamos que navegue a la URL real
        });
    });
    }

    /* ---------- active link (mÃ¡s robusto) ---------- */
    function updateActiveLink() {
        const pathname = window.location.pathname.replace(/\/index\.html$/, '/');
        const base = `/${currentLang}`;
        const links = {
            home: ['nav-home','mobile-nav-home'],
            guitars: ['nav-guitars','mobile-nav-guitars'],
            contact: ['nav-contact','mobile-nav-contact']
        };

        // reset
        Object.values(links).flat().forEach(id => {
            const el = document.getElementById(id);
            if (el) {
            el.classList.remove('active');
            el.classList.add('inactive');
            }
        });

        if (pathname === `${base}/` || pathname === `${base}`) {
            links.home.forEach(id => { const el=document.getElementById(id); if(el){el.classList.remove('inactive'); el.classList.add('active')}});
        } else if (pathname.includes(`${base}/guitarras`)) {
            links.guitars.forEach(id => { const el=document.getElementById(id); if(el){el.classList.remove('inactive'); el.classList.add('active')}});
        } else if (pathname.includes(`${base}/contacto`)) {
            links.contact.forEach(id => { const el=document.getElementById(id); if(el){el.classList.remove('inactive'); el.classList.add('active')}});
        }
    }

    /* ---------- toggles UI ---------- */
    function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobile-menu');
        if (!mobileMenu) return;
        menuOpen = !menuOpen;
        mobileMenu.classList.toggle('hidden');
    }
    function toggleLangDropdown(e) {
        if (e && e.stopPropagation) e.stopPropagation();

        langDropdownOpen = !langDropdownOpen;
        const dd = document.getElementById('lang-dropdown');
        if (!dd) return;

        if (langDropdownOpen) {
            dd.classList.remove('hidden');
            const firstOpt = dd.querySelector('.lang-option');
            if (firstOpt && firstOpt.focus) firstOpt.focus();

            // aÃ±adimos el listener de cierre *despuÃ©s* del click actual para evitar que
            // el mismo evento que abriÃ³ el dropdown lo cierre inmediatamente.
            setTimeout(() => {
            document.addEventListener('click', docCloseHandler);
            }, 0);
        } else {
            dd.classList.add('hidden');
            // por si acaso, remover el listener
            document.removeEventListener('click', docCloseHandler);
        }
    }
    function openMobileLangPopup() {
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu) mobileMenu.classList.add('hidden');
        const popup = document.getElementById('mobile-lang-popup');
        if (popup) popup.classList.remove('hidden');
    }
    function closeMobileLangPopup() {
        const popup = document.getElementById('mobile-lang-popup');
        if (popup) popup.classList.add('hidden');
    }

    /* ---------- cambio de idioma (preserva la ruta) ---------- */
    function changeLanguage(lang) {
        if (lang !== 'es' && lang !== 'en') return;
        setCookie('preferred_language', lang, 365);
        currentLang = lang;
        document.documentElement.lang = lang;
        updateTexts();
        setupLinks();
        updateActiveLink();
        // Redirigir a la misma ruta con el primer segmento cambiado/insertado
        const newPath = buildPathWithLang(lang);
        if (newPath !== window.location.pathname) {
            window.location.href = newPath;
        }
    }

    /* ---------- inicializaciÃ³n ---------- */
    function initNavbar() {
        // cookie
        const cookieLang = getCookie('preferred_language');
        if (cookieLang === 'es' || cookieLang === 'en') currentLang = cookieLang;
        document.documentElement.lang = currentLang;

        updateTexts();
        setupLinks();
        setupNavLinkLoading();
        updateActiveLink();

        // eventos UI
        const mobileBtn = document.getElementById('mobile-menu-button');
        if (mobileBtn) mobileBtn.addEventListener('click', toggleMobileMenu);
        const langTrigger = document.getElementById('lang-trigger');
        if (langTrigger) {
            // abrimos en click y evitamos bubbling; el listener global se aÃ±ade despuÃ©s
            langTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleLangDropdown(e);
            });
        }
        const ddEs = document.getElementById('lang-option-es');
        const ddEn = document.getElementById('lang-option-en');
        if (ddEs) ddEs.addEventListener('click', () => changeLanguage('es'));
        if (ddEn) ddEn.addEventListener('click', () => changeLanguage('en'));

        const mobileLangBtn = document.getElementById('mobile-lang-button');
        if (mobileLangBtn) mobileLangBtn.addEventListener('click', openMobileLangPopup);
        const mobileLangEs = document.getElementById('mobile-lang-option-es');
        const mobileLangEn = document.getElementById('mobile-lang-option-en');
        if (mobileLangEs) mobileLangEs.addEventListener('click', () => { changeLanguage('es'); closeMobileLangPopup(); });
        if (mobileLangEn) mobileLangEn.addEventListener('click', () => { changeLanguage('en'); closeMobileLangPopup(); });
        const closeLangBtn = document.getElementById('close-lang-popup');
        if (closeLangBtn) closeLangBtn.addEventListener('click', closeMobileLangPopup);

        // si la URL actual NO contiene segmento de idioma, redirigir segÃºn cookie/por defecto
        const parts = window.location.pathname.split('/');
        if (!parts[1] || (parts[1] !== 'es' && parts[1] !== 'en')) {
            const newPath = buildPathWithLang(currentLang);
            // use replace to avoid extra history entry
            window.location.replace(newPath);
            return;
        }
    }

    function docCloseHandler(e) {
        const langTrigger = document.getElementById('lang-trigger');
        const langDropdown = document.getElementById('lang-dropdown');
        if (!langDropdown) return;
        if (langDropdown.classList.contains('hidden')) return;

        const target = e.target;
        if ((langTrigger && langTrigger.contains(target)) || langDropdown.contains(target)) {
            return;
        }

        langDropdown.classList.add('hidden');
        langDropdownOpen = false;
        // quitar el listener cuando cerramos
        document.removeEventListener('click', docCloseHandler);
    }

    /* DOM ready */
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNavbar);
    } else {
        initNavbar();
    }
</script>